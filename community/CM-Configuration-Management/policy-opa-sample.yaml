apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: policy-opa-sample
  annotations:
    policy.open-cluster-management.io/standards: NIST SP 800-53
    policy.open-cluster-management.io/categories: CM Configuration Management
    policy.open-cluster-management.io/controls: CM-2 Baseline Configuration
    integrityshield.io/message: H4sIAAAAAAAAA5VV32vbMBB+919xGAbdiLxuYzAMfWi7MfrQUdqylxCKYp8TLbakSbLX0PV/70mJHSd101QPIZbuvrv77hfX4jcaK5RMQatSZMtEaZQsK2vr0LCKSz7DCqVLhPrYfIoWQuYpXAXRqELHc+54GgFIXmGLwZTmzPJKl0gvXErluCMb1gvCAYas4zLnJrcp/Lq4uYWbK/h2fMy+fjlQP+MOZ8oIJIDzSzhXshCz2gQn4LITPRRNSWdUGbDYZzjjFkshcRs2shozH58hvVyEu9PMBWZRFspknotcWD4tkSgseGn9zZoxh8QWeb2miIGa/sHMfcdCSBFQwr0//K05axVXudvyep3IVqKf0PY8S2wWACquO6E29PbspaBTwgaNcMsU5mI23zFoNc/wBkuiQJk+NADeU6A5uTSOF/UU2Yd4svUuZPeeY8Hr0m0JrHjd5bs9DDJFD4LLDG+XmlAqInXOG9wSgz3pGUpTLwnt2aW5i17daZUnhuo3hf9sQIJqhmcLSjH4+I1EiiLheSWsNzaokKNcjis7m8DD4Ls/Qurakd2/NVqX+FoJP3ByAvGVyuMDFbvsBUWqlz2KlQ8iPdlBWFGb+KJKfOtx6jVjx3eTJCi8CEdTBmhwGGf/CTc/CsIjiOeKSpeAqvj9i6pEjffDaiOkK47ilWcFF6UFp3xN0JdRFTjjeyynCp8J6wwV77smHsE4KEyGDTw+u+034mWvjzp3BtqwizK0o1RUJBFjLHrzNFhP8JJS5G/P6FPI2cAsn65e2Kb1I91qXWPRG/rtbV+0jbIzdF2vtoEWP42qdUr/tN3ja2TrUAihQ9me/dJZ2syyjZFXKXlG4ituDVAYIhvYhUO0tKNyjU01kIveamS+gl1Nqya+NTW2vePCKFotrvx8R/W0oTr1W2UDuz05K+6y+Y97bTBMiG7kMXhY4NLP5kYYJb2rI6DIaTWQKlzIETS8rP0S9bO0iSeP0RP9pdHFMQgAAA==
    integrityshield.io/signature: LS0tLS1CRUdJTiBQR1AgU0lHTkFUVVJFLS0tLS0KCmlRSEZCQUFCQ2dBdkZpRUVkZENIUWpWblNBUmhaMytYbTBOT3crQXJsb2NGQW1CSzJUSVJIR2RoYW1GdVFHcHcKTG1saWJTNWpiMjBBQ2drUW0wTk93K0FybG9mb0RRditOakFtL0hFT0lKUmFKeC9BblM0eWhKVWVTQVFTVmZkRgpvdzV4d3J2VGNjUUVwOWM3RTBrckdFQUZTcWF0U3Rpb011QXhRTGxWYkM3RmhpZWhmNzBuN2FGV09kTGpzblZ3CmFvVE12UkhsTUxscTlOakZ1ZHpJVXd4ejJxYWxoQ2x4VncwMXVUeVl5eDNCbzdtSWpBT1REdW9WTS82dC9jcDgKRWplOE5rNENSclFuSjdFWXFIcmR4NlV3c1k3KzdLTGdVNDVOazNFUmVYS24yOXlWRFkyYzY5eWkzdjc2M0pWWgpZV3BkbkRQRHNiVWdOT0dxREJla3NUSElNM01zMzRWdzU2RG56blVkNkk1ZnBGdHVFMm9nMEFhdTBFdndUSkhpCkZOS3pmZ0lma0FaVndYbEM1cTZya3BTM2lFZmQ5K0FVYzBpUEJ3U1cvWEpwYmdBYStjb25WNVpzWE1XektXTWQKOXJPaWdhbm5HSEdDMTNJdnZ4RCswNERWK2hKQnpTTE96TlBPRldBaVVmWEIxdERHQk10WEJYdTJ6MStocmR0cQo0eFNZVVR0d0ZKbE5iS0EwNkltRnQvbWpVMHJndGpSZTB4RE5zRVVCK0QwMHRBb3dQOEV2L0ZnTGFmaTdJZlFQCnFRWXl4dVVOblM2VWpLTXVEVVVNTjZxOWJWSERsK1FsCj1PQlZ4Ci0tLS0tRU5EIFBHUCBTSUdOQVRVUkUtLS0tLQo=
spec:
  remediationAction: enforce
  disabled: false
  policy-templates:
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: policy-opa-configmap
        spec:
          remediationAction: enforce
          severity: high
          namespaceSelector:
            exclude: ["kube-*"]
            include: ["default"]
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: v1
                data:
                  no_pod.rego: |-
                    package kubernetes.admission
                    deny[msg] {
                        input.request.kind.kind == "Pod"
                        input.request.namespace == "opa"
                        image := input.request.object.spec.containers[_].image
                        not startswith(image, "hooli.com")
                        msg := sprintf("image fails to come from trusted registry: %v", [image])
                    }
                kind: ConfigMap
                metadata:
                  name: nopod
---
apiVersion: policy.open-cluster-management.io/v1
kind: PlacementBinding
metadata:
  name: binding-policy-opa
  annotations:
    integrityshield.io/message: H4sIAAAAAAAAA5VV32vbMBB+919xGAbdiLxuYzAMfWi7MfrQUdqylxCKYp8TLbakSbLX0PV/70mJHSd101QPIZbuvrv77hfX4jcaK5RMQatSZMtEaZQsK2vr0LCKSz7DCqVLhPrYfIoWQuYpXAXRqELHc+54GgFIXmGLwZTmzPJKl0gvXErluCMb1gvCAYas4zLnJrcp/Lq4uYWbK/h2fMy+fjlQP+MOZ8oIJIDzSzhXshCz2gQn4LITPRRNSWdUGbDYZzjjFkshcRs2shozH58hvVyEu9PMBWZRFspknotcWD4tkSgseGn9zZoxh8QWeb2miIGa/sHMfcdCSBFQwr0//K05axVXudvyep3IVqKf0PY8S2wWACquO6E29PbspaBTwgaNcMsU5mI23zFoNc/wBkuiQJk+NADeU6A5uTSOF/UU2Yd4svUuZPeeY8Hr0m0JrHjd5bs9DDJFD4LLDG+XmlAqInXOG9wSgz3pGUpTLwnt2aW5i17daZUnhuo3hf9sQIJqhmcLSjH4+I1EiiLheSWsNzaokKNcjis7m8DD4Ls/Qurakd2/NVqX+FoJP3ByAvGVyuMDFbvsBUWqlz2KlQ8iPdlBWFGb+KJKfOtx6jVjx3eTJCi8CEdTBmhwGGf/CTc/CsIjiOeKSpeAqvj9i6pEjffDaiOkK47ilWcFF6UFp3xN0JdRFTjjeyynCp8J6wwV77smHsE4KEyGDTw+u+034mWvjzp3BtqwizK0o1RUJBFjLHrzNFhP8JJS5G/P6FPI2cAsn65e2Kb1I91qXWPRG/rtbV+0jbIzdF2vtoEWP42qdUr/tN3ja2TrUAihQ9me/dJZ2syyjZFXKXlG4ituDVAYIhvYhUO0tKNyjU01kIveamS+gl1Nqya+NTW2vePCKFotrvx8R/W0oTr1W2UDuz05K+6y+Y97bTBMiG7kMXhY4NLP5kYYJb2rI6DIaTWQKlzIETS8rP0S9bO0iSeP0RP9pdHFMQgAAA==
    integrityshield.io/signature: LS0tLS1CRUdJTiBQR1AgU0lHTkFUVVJFLS0tLS0KCmlRSEZCQUFCQ2dBdkZpRUVkZENIUWpWblNBUmhaMytYbTBOT3crQXJsb2NGQW1CSzJUSVJIR2RoYW1GdVFHcHcKTG1saWJTNWpiMjBBQ2drUW0wTk93K0FybG9mb0RRditOakFtL0hFT0lKUmFKeC9BblM0eWhKVWVTQVFTVmZkRgpvdzV4d3J2VGNjUUVwOWM3RTBrckdFQUZTcWF0U3Rpb011QXhRTGxWYkM3RmhpZWhmNzBuN2FGV09kTGpzblZ3CmFvVE12UkhsTUxscTlOakZ1ZHpJVXd4ejJxYWxoQ2x4VncwMXVUeVl5eDNCbzdtSWpBT1REdW9WTS82dC9jcDgKRWplOE5rNENSclFuSjdFWXFIcmR4NlV3c1k3KzdLTGdVNDVOazNFUmVYS24yOXlWRFkyYzY5eWkzdjc2M0pWWgpZV3BkbkRQRHNiVWdOT0dxREJla3NUSElNM01zMzRWdzU2RG56blVkNkk1ZnBGdHVFMm9nMEFhdTBFdndUSkhpCkZOS3pmZ0lma0FaVndYbEM1cTZya3BTM2lFZmQ5K0FVYzBpUEJ3U1cvWEpwYmdBYStjb25WNVpzWE1XektXTWQKOXJPaWdhbm5HSEdDMTNJdnZ4RCswNERWK2hKQnpTTE96TlBPRldBaVVmWEIxdERHQk10WEJYdTJ6MStocmR0cQo0eFNZVVR0d0ZKbE5iS0EwNkltRnQvbWpVMHJndGpSZTB4RE5zRVVCK0QwMHRBb3dQOEV2L0ZnTGFmaTdJZlFQCnFRWXl4dVVOblM2VWpLTXVEVVVNTjZxOWJWSERsK1FsCj1PQlZ4Ci0tLS0tRU5EIFBHUCBTSUdOQVRVUkUtLS0tLQo=
placementRef:
  name: placement-policy-opa
  kind: PlacementRule
  apiGroup: apps.open-cluster-management.io
subjects:
  - name: policy-opa-sample
    kind: Policy
    apiGroup: policy.open-cluster-management.io
---
apiVersion: apps.open-cluster-management.io/v1
kind: PlacementRule
metadata:
  name: placement-policy-opa
  annotations:
    integrityshield.io/message: H4sIAAAAAAAAA5VV32vbMBB+919xGAbdiLxuYzAMfWi7MfrQUdqylxCKYp8TLbakSbLX0PV/70mJHSd101QPIZbuvrv77hfX4jcaK5RMQatSZMtEaZQsK2vr0LCKSz7DCqVLhPrYfIoWQuYpXAXRqELHc+54GgFIXmGLwZTmzPJKl0gvXErluCMb1gvCAYas4zLnJrcp/Lq4uYWbK/h2fMy+fjlQP+MOZ8oIJIDzSzhXshCz2gQn4LITPRRNSWdUGbDYZzjjFkshcRs2shozH58hvVyEu9PMBWZRFspknotcWD4tkSgseGn9zZoxh8QWeb2miIGa/sHMfcdCSBFQwr0//K05axVXudvyep3IVqKf0PY8S2wWACquO6E29PbspaBTwgaNcMsU5mI23zFoNc/wBkuiQJk+NADeU6A5uTSOF/UU2Yd4svUuZPeeY8Hr0m0JrHjd5bs9DDJFD4LLDG+XmlAqInXOG9wSgz3pGUpTLwnt2aW5i17daZUnhuo3hf9sQIJqhmcLSjH4+I1EiiLheSWsNzaokKNcjis7m8DD4Ls/Qurakd2/NVqX+FoJP3ByAvGVyuMDFbvsBUWqlz2KlQ8iPdlBWFGb+KJKfOtx6jVjx3eTJCi8CEdTBmhwGGf/CTc/CsIjiOeKSpeAqvj9i6pEjffDaiOkK47ilWcFF6UFp3xN0JdRFTjjeyynCp8J6wwV77smHsE4KEyGDTw+u+034mWvjzp3BtqwizK0o1RUJBFjLHrzNFhP8JJS5G/P6FPI2cAsn65e2Kb1I91qXWPRG/rtbV+0jbIzdF2vtoEWP42qdUr/tN3ja2TrUAihQ9me/dJZ2syyjZFXKXlG4ituDVAYIhvYhUO0tKNyjU01kIveamS+gl1Nqya+NTW2vePCKFotrvx8R/W0oTr1W2UDuz05K+6y+Y97bTBMiG7kMXhY4NLP5kYYJb2rI6DIaTWQKlzIETS8rP0S9bO0iSeP0RP9pdHFMQgAAA==
    integrityshield.io/signature: LS0tLS1CRUdJTiBQR1AgU0lHTkFUVVJFLS0tLS0KCmlRSEZCQUFCQ2dBdkZpRUVkZENIUWpWblNBUmhaMytYbTBOT3crQXJsb2NGQW1CSzJUSVJIR2RoYW1GdVFHcHcKTG1saWJTNWpiMjBBQ2drUW0wTk93K0FybG9mb0RRditOakFtL0hFT0lKUmFKeC9BblM0eWhKVWVTQVFTVmZkRgpvdzV4d3J2VGNjUUVwOWM3RTBrckdFQUZTcWF0U3Rpb011QXhRTGxWYkM3RmhpZWhmNzBuN2FGV09kTGpzblZ3CmFvVE12UkhsTUxscTlOakZ1ZHpJVXd4ejJxYWxoQ2x4VncwMXVUeVl5eDNCbzdtSWpBT1REdW9WTS82dC9jcDgKRWplOE5rNENSclFuSjdFWXFIcmR4NlV3c1k3KzdLTGdVNDVOazNFUmVYS24yOXlWRFkyYzY5eWkzdjc2M0pWWgpZV3BkbkRQRHNiVWdOT0dxREJla3NUSElNM01zMzRWdzU2RG56blVkNkk1ZnBGdHVFMm9nMEFhdTBFdndUSkhpCkZOS3pmZ0lma0FaVndYbEM1cTZya3BTM2lFZmQ5K0FVYzBpUEJ3U1cvWEpwYmdBYStjb25WNVpzWE1XektXTWQKOXJPaWdhbm5HSEdDMTNJdnZ4RCswNERWK2hKQnpTTE96TlBPRldBaVVmWEIxdERHQk10WEJYdTJ6MStocmR0cQo0eFNZVVR0d0ZKbE5iS0EwNkltRnQvbWpVMHJndGpSZTB4RE5zRVVCK0QwMHRBb3dQOEV2L0ZnTGFmaTdJZlFQCnFRWXl4dVVOblM2VWpLTXVEVVVNTjZxOWJWSERsK1FsCj1PQlZ4Ci0tLS0tRU5EIFBHUCBTSUdOQVRVUkUtLS0tLQo=
spec:
  clusterConditions:
    - status: "True"
      type: ManagedClusterConditionAvailable
  clusterSelector:
    matchExpressions:
      - {key: environment, operator: In, values: ["dev"]}
